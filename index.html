<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Area QNH Map</title>
  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@3.5.2/dist/maplibre-gl.css" />
  <style>
    :root {
      --panel: #f7f7f7;
      --stroke: #d6d6d6;
      --label-red: #c40000;
    }
    body {
      margin: 0;
      font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
      background: #ffffff;
      color: #111;
      display: grid;
      grid-template-rows: auto 1fr;
      min-height: 100vh;
    }
    header {
      padding: 14px 18px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--panel);
      border-bottom: 1px solid var(--stroke);
      gap: 8px;
      flex-wrap: wrap;
    }
    .title h1 { margin: 0; font-size: 1.1rem; }
    .title .sub { margin: 0; font-size: 0.9rem; color: #555; }
    #validity {
      margin-left: auto;
      font-size: 0.9rem;
      color: #444;
      white-space: nowrap;
    }
    main {
      padding: 16px;
      display: flex;
      flex-direction: column;
    }
    #map {
      width: 100%;
      height: 100%;
      flex: 1 1 auto;
      min-height: 0;
      border: 1px solid var(--stroke);
      border-radius: 12px;
      box-shadow: 0 16px 40px rgba(0, 0, 0, 0.18);
      background: #edf1f5;
    }
  </style>
</head>
<body>
  <header>
    <div class="title">
      <h1>Area QNH Map</h1>
      <p class="sub">Replica of the BOM Area QNH Map removed from the new BOM website.</p>
    </div>
    <div id="validity">Fetching QNH…</div>
  </header>

  <main>
    <div id="map" aria-label="Area QNH map"></div>
  </main>

  <script src="https://unpkg.com/maplibre-gl@3.5.2/dist/maplibre-gl.js"></script>
  <script>
    const map = new maplibregl.Map({
      container: 'map',
      style: {
        version: 8,
        glyphs: 'https://fonts.openmaptiles.org/{fontstack}/{range}.pbf',
        sources: {
          osm: {
            type: 'raster',
            tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
            tileSize: 256,
            attribution: '© OpenStreetMap contributors'
          }
        },
        layers: [{ id: 'osm-base', type: 'raster', source: 'osm' }]
      },
      center: [134.5, -25.5],
      zoom: 3.6
    });

    map.addControl(new maplibregl.NavigationControl(), 'top-left');

    const AREA_DATA_URL = 'data/gaf-areas.geojson';
    const QNH_WORKER_URL = 'https://areaqnh.therealleviticus.workers.dev/';

    let areaGeoJSON = null;
    let areaQnhMap = {};

    map.on('load', () => {
      loadAreas();
      startQNHLoop();
    });

    async function loadAreas() {
      const res = await fetch(AREA_DATA_URL);
      const geojson = await res.json();
      geojson.features.forEach((f, i) => f.id = i + 1);
      areaGeoJSON = geojson;

      map.addSource('areas', { type: 'geojson', data: geojson });

      map.addLayer({
        id: 'areas-fill',
        type: 'fill',
        source: 'areas',
        paint: { 'fill-color': '#ffffff', 'fill-opacity': 0.30 }
      });

      map.addLayer({
        id: 'areas-line',
        type: 'line',
        source: 'areas',
        paint: { 'line-color': '#d40000', 'line-width': 2 }
      });

      // Combined QNH + Area label
      map.addLayer({
        id: 'areas-label',
        type: 'symbol',
        source: 'areas',
        layout: {
          'text-field': [
            'format',
            ['to-string', ['coalesce', ['get', 'qnh'], '']],
            { 'font-scale': 1.0, 'text-color': '#000', 'font-weight': 'bold' },
            '\n',
            ['concat', 'AREA ', ['slice', ['get', 'area_code'], 5]],
            { 'font-scale': 0.7, 'text-color': '#c40000' }
          ],
          'text-font': ['Open Sans Regular'],
          'text-size': 18,
          'text-allow-overlap': true,
          'text-ignore-placement': true,
          'text-variable-anchor': ['center'],
          'symbol-z-order': 'source'
        },
        paint: {
          'text-halo-color': '#fff',
          'text-halo-width': 1.2
        }
      });

      applyAreaQnhToPolygons();
      fitToAreas(geojson);
    }

    function startQNHLoop() {
      fetchAndDrawQNH();
      setInterval(fetchAndDrawQNH, 15 * 60 * 1000);
    }

    async function fetchAndDrawQNH() {
      const validityBox = document.getElementById('validity');
      try {
        const res = await fetch(QNH_WORKER_URL + '?t=' + Date.now(), { cache: 'no-store' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const raw = await res.text();

        // Clean HTML to plain text
        let text = raw
          .replace(/<script[^>]*>[\s\S]*?<\/script>/gi, '')
          .replace(/<style[^>]*>[\s\S]*?<\/style>/gi, '')
          .replace(/<br\s*\/?>/gi, '\n')
          .replace(/<\/(p|div|li|h\d|section)>/gi, '\n')
          .replace(/<[^>]+>/g, ' ')
          .replace(/&nbsp;/g, ' ')
          .replace(/&amp;/g, '&')
          .replace(/&lt;/g, '<')
          .replace(/&gt;/g, '>')
          .replace(/[ \t]+\n/g, '\n')
          .replace(/\n[ \t]+/g, '\n')
          .replace(/\n{3,}/g, '\n\n')
          .trim();

        const parsed = parseQNHText(text);
        areaQnhMap = parsed.areaQnhMap;
        applyAreaQnhToPolygons();

        const v = parsed.validIssued;
        const areaCount = Object.keys(parsed.areaQnhMap || {}).length;
        const totalAreas = areaGeoJSON?.features?.length || '?';
        validityBox.textContent = v
          ? `Valid: ${v.valid} · Issued: ${v.issued} · Areas ${areaCount}/${totalAreas}`
          : `Validity unknown · Areas ${areaCount}/${totalAreas}`;
      } catch (err) {
        console.error('Failed to fetch/parse QNH', err);
        document.getElementById('validity').textContent = 'Failed to fetch QNH';
      }
    }

    function parseQNHText(text) {
      const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
      const blocks = [];
      let current = null;
      for (const line of lines) {
        const m = line.match(/^(?:AREA|Area)\s*(\d+)\s*:(.*)$/);
        if (m) {
          if (current) blocks.push(current);
          current = { area: `AREA-${m[1]}`, lines: [] };
          const rest = m[2]?.trim();
          if (rest) current.lines.push(rest);
          continue;
        }
        if (/^Valid:/i.test(line) && current) {
          blocks.push(current);
          current = null;
          continue;
        }
        if (current) current.lines.push(line);
      }
      if (current) blocks.push(current);

      const areaQnhMapLocal = {};
      for (const b of blocks) {
        const txt = b.lines.join(' ');
        const matches = [...txt.matchAll(/\b(\d{4})\b/g)].map(m => Number(m[1]));
        const qnh = matches.find(n => n >= 900 && n <= 1050) ?? null;
        if (qnh) areaQnhMapLocal[b.area] = { qnh };
      }

      const validAll = [...text.matchAll(/Valid:\s*([^\n]*?)(?=Issued:|\n|$)/gi)];
      const issuedAll = [...text.matchAll(/Issued:\s*([^\n]*)/gi)];
      const validIssued = (validAll.length && issuedAll.length)
        ? { valid: validAll.at(-1)[1].trim(), issued: issuedAll.at(-1)[1].trim() }
        : null;

      return { areaQnhMap: areaQnhMapLocal, validIssued };
    }

    function applyAreaQnhToPolygons() {
      if (!areaGeoJSON) return;
      let count = 0;
      areaGeoJSON.features.forEach(f => {
        const code = f.properties?.area_code?.toUpperCase();
        const match = areaQnhMap[code];
        if (match) {
          f.properties.qnh = match.qnh;
          count++;
        } else {
          delete f.properties.qnh;
        }
      });
      if (map.getSource('areas')) map.getSource('areas').setData(areaGeoJSON);
      console.log('Applied QNH to', count, 'areas');
    }

    function fitToAreas(geojson) {
      const bounds = getGeoJsonBounds(geojson);
      if (bounds) map.fitBounds(bounds, { padding: 40, maxZoom: 6 });
    }

    function getGeoJsonBounds(geojson) {
      let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
      const update = ([x, y]) => {
        if (!Number.isFinite(x) || !Number.isFinite(y)) return;
        if (x < -180 || x > 180 || y < -90 || y > 90) return;
        if (x < minX) minX = x;
        if (x > maxX) maxX = x;
        if (y < minY) minY = y;
        if (y > maxY) maxY = y;
      };
      const walk = coords => {
        if (!Array.isArray(coords)) return;
        if (typeof coords[0] === 'number') update(coords);
        else coords.forEach(walk);
      };
      if (!geojson?.features) return null;
      geojson.features.forEach(f => f.geometry?.coordinates && walk(f.geometry.coordinates));
      if (!Number.isFinite(minX)) return null;
      return [[minX, minY], [maxX, maxY]];
    }
  </script>
</body>
</html>
